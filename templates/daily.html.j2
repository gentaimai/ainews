<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ date }} のAIニュースまとめ - ainews.komee.org</title>
  <meta name="description" content="生成AI・ChatGPT関連ニュースを自動収集・要約。{{ date }} のトピック一覧。">
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto; margin:0;background:#0b0f14;color:#e6edf3;}
    header{background:#121821;padding:16px;font-size:20px;font-weight:bold;border-bottom:1px solid #111722;}
    a{color:#4cc2ff;text-decoration:none}
    main{max-width:900px;margin:auto;padding:16px;}
    article{background:#121821;margin:12px 0;padding:12px;border-radius:12px;border:1px solid #111722}
    .src{color:#8b98a5;font-size:13px}
    footer{color:#8b98a5;text-align:center;padding:20px;font-size:13px;border-top:1px solid #111722}
    .news { padding:8px 0; }
    .news .news-summary{
      margin-top:4px; font-size:12px; color:#8b98a5; line-height:1.5;
    }
    .news .news-summary.loading{ opacity:.7; }
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6238004847920381" crossorigin="anonymous"></script>
</head>
<body>
<header><a href="../index.html">📰 生成AIニュースまとめ</a></header>
<main>
  <h2>{{ date }} のニュース一覧</h2>
  {% for i in items %}
<article class="news">
  <a class="news-link" href="{{ i.link }}" target="_blank" rel="noopener"><b>{{ i.title }}</b></a>
  <div class="src">{{ i.source }} — {{ i.date }}</div>
  <p>{{ i.summary }}</p>

  <!-- Worker から取得した 1行要約を差し込む領域（初期はローディング表示） -->
  <div class="news-summary loading">要約を取得中…</div>
</article>
{% endfor %}

</main>
<footer>© {{ date[:4] }} komee.org — 自動生成ニュース</footer>
<script>
  const SUM_API = 'https://news-summary.ainews-worker.workers.dev/summarize';

  // 修正：root が Event/undefined でも document を使う
  async function attachSummaries(root) {
    const scope = (root && typeof root.querySelectorAll === 'function') ? root : document;

    const articles = Array.from(scope.querySelectorAll('article.news'));
    for (const el of articles) {
      let holder = el.querySelector('.news-summary');
      if (!holder) {
        holder = document.createElement('div');
        holder.className = 'news-summary loading';
        holder.textContent = '要約を取得中…';
        el.appendChild(holder);
      }
      if (holder.dataset.done === '1') continue;

      // URL検出
      const link =
        el.querySelector('a.news-link[href^="http"]') ||
        el.querySelector('a[href^="http"]');
      const targetUrl = link?.href || el.getAttribute('data-link');

      if (!targetUrl) {
        holder.textContent = '（リンクが見つかりません）';
        holder.classList.remove('loading');
        holder.dataset.done = '1';
        console.warn('[summary] link not found in', el);
        continue;
      }

      try {
        const ctrl = new AbortController();
        const timeout = setTimeout(() => ctrl.abort('timeout'), 15000);
        const res = await fetch(`${SUM_API}?url=${encodeURIComponent(targetUrl)}`, { signal: ctrl.signal });
        clearTimeout(timeout);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const j = await res.json().catch(() => ({}));
        const text = (j.summary || '').trim();
        holder.textContent = text || '（要約なし）';
      } catch (e) {
        holder.textContent = '（要約の取得に失敗しました）';
        console.error('[summary] fetch failed:', e);
      } finally {
        holder.classList.remove('loading');
        holder.dataset.done = '1';
      }
    }
  }

  // 修正：load 時は引数なしで呼ぶ（イベントが渡らないようにする）
  window.addEventListener('load', () => attachSummaries());

  // 以降はお好みで（動的追加に対応）
  const obs = new MutationObserver(muts => {
    for (const m of muts) {
      for (const node of m.addedNodes) {
        if (node?.nodeType !== 1) continue;
        if (node.matches?.('article.news') || node.querySelector?.('article.news')) {
          attachSummaries(node);  // ここは Element を渡すのでOK
        }
      }
    }
  });
  obs.observe(document.body, { childList: true, subtree: true });
</script>

</body>
</html>
