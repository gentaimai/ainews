<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ date }} ã®AIãƒ‹ãƒ¥ãƒ¼ã‚¹ã¾ã¨ã‚ - ainews.komee.org</title>
  <meta name="description" content="ç”ŸæˆAIãƒ»ChatGPTé–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è‡ªå‹•åé›†ãƒ»è¦ç´„ã€‚{{ date }} ã®ãƒˆãƒ”ãƒƒã‚¯ä¸€è¦§ã€‚">
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto; margin:0;background:#0b0f14;color:#e6edf3;}
    header{background:#121821;padding:16px;font-size:20px;font-weight:bold;border-bottom:1px solid #111722;}
    a{color:#4cc2ff;text-decoration:none}
    main{max-width:900px;margin:auto;padding:16px;}
    article{background:#121821;margin:12px 0;padding:12px;border-radius:12px;border:1px solid #111722}
    .src{color:#8b98a5;font-size:13px}
    footer{color:#8b98a5;text-align:center;padding:20px;font-size:13px;border-top:1px solid #111722}
    .news { padding:8px 0; }
    .news .news-summary{
      margin-top:4px; font-size:12px; color:#8b98a5; line-height:1.5;
    }
    .news .news-summary.loading{ opacity:.7; }
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6238004847920381" crossorigin="anonymous"></script>
</head>
<body>
<header><a href="../index.html">ğŸ“° ç”ŸæˆAIãƒ‹ãƒ¥ãƒ¼ã‚¹ã¾ã¨ã‚</a></header>
<main>
  <h2>{{ date }} ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§</h2>
  {% for i in items %}
<article class="news">
  <a class="news-link" href="{{ i.link }}" target="_blank" rel="noopener"><b>{{ i.title }}</b></a>
  <div class="src">{{ i.source }} â€” {{ i.date }}</div>
  <p>{{ i.summary }}</p>

  <!-- Worker ã‹ã‚‰å–å¾—ã—ãŸ 1è¡Œè¦ç´„ã‚’å·®ã—è¾¼ã‚€é ˜åŸŸï¼ˆåˆæœŸã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼‰ -->
  <div class="news-summary loading">è¦ç´„ã‚’å–å¾—ä¸­â€¦</div>
</article>
{% endfor %}

</main>
<footer>Â© {{ date[:4] }} komee.org â€” è‡ªå‹•ç”Ÿæˆãƒ‹ãƒ¥ãƒ¼ã‚¹</footer>
<script>
  const SUM_API = 'https://news-summary.ainews-worker.workers.dev/summarize';

  // .news å†…ã‹ã‚‰ã€Œè¦ç´„å¯¾è±¡URLã€ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆ.news-link ãŒç„¡ã‘ã‚Œã°å…ˆé ­ã®å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ï¼‰
  function pickArticleUrl(container) {
    // 1) .news-link ã‚’å„ªå…ˆ
    const preferred = container.querySelector('a.news-link[href^="http"]');
    if (preferred?.href) return preferred.href;

    // 2) æœ€åˆã®å¤–éƒ¨ãƒªãƒ³ã‚¯ï¼ˆhttp/httpsï¼‰ã‚’ä½¿ç”¨
    const any = container.querySelector('a[href^="http"]');
    if (any?.href) return any.href;

    // 3) data-link å±æ€§ã«URLãŒå…¥ã£ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã«ã‚‚å¯¾å¿œï¼ˆä»»æ„ï¼‰
    const data = container.getAttribute('data-link');
    if (data && /^https?:\/\//.test(data)) return data;

    return null;
  }

  async function attachSummaries(root = document) {
    const articles = Array.from(root.querySelectorAll('article.news'));

    for (const el of articles) {
      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼ˆæ—¢ã«ãƒ†ãƒ³ãƒ—ãƒ¬ã«å…¥ã£ã¦ã„ã‚‹æƒ³å®šã€‚ç„¡ã‘ã‚Œã°ä½œã‚‹ï¼‰
      let holder = el.querySelector('.news-summary');
      if (!holder) {
        holder = document.createElement('div');
        holder.className = 'news-summary loading';
        holder.textContent = 'è¦ç´„ã‚’å–å¾—ä¸­â€¦';
        el.appendChild(holder);
      }

      // æ—¢ã«å‡¦ç†æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
      if (holder.dataset.done === '1') continue;

      const targetUrl = pickArticleUrl(el);
      if (!targetUrl) {
        holder.textContent = 'ï¼ˆãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰';
        holder.classList.remove('loading');
        holder.dataset.done = '1';
        console.warn('[summary] link not found in', el);
        continue;
      }

      try {
        // ä¸€å¿œãƒ­ã‚°ï¼ˆDevTools Console ã§åŸå› è¿½è·¡ç”¨ï¼‰
        console.debug('[summary] fetching:', targetUrl);

        const ctrl = new AbortController();
        const timeout = setTimeout(() => ctrl.abort('timeout'), 15000); // 15s ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        const res = await fetch(`${SUM_API}?url=${encodeURIComponent(targetUrl)}`, { signal: ctrl.signal });
        clearTimeout(timeout);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const j = await res.json().catch(() => ({}));
        const text = (j.summary || '').trim();

        holder.textContent = text || 'ï¼ˆè¦ç´„ãªã—ï¼‰';
      } catch (e) {
        holder.textContent = 'ï¼ˆè¦ç´„ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼‰';
        console.error('[summary] fetch failed:', e);
      } finally {
        holder.classList.remove('loading');
        holder.dataset.done = '1';
      }
    }
  }

  // ãƒšãƒ¼ã‚¸èª­è¾¼å®Œäº†ã§å®Ÿè¡Œ
  window.addEventListener('load', () => {
    attachSummaries();

    // å¾Œã‹ã‚‰è¨˜äº‹ãŒè¿½åŠ ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œï¼ˆå¿…è¦ãªã‘ã‚Œã°å‰Šé™¤OKï¼‰
    const obs = new MutationObserver(muts => {
      for (const m of muts) {
        for (const node of m.addedNodes) {
          if (node?.nodeType !== 1) continue;
          if (node.matches?.('article.news') || node.querySelector?.('article.news')) {
            attachSummaries(node);
          }
        }
      }
    });
    obs.observe(document.body, { childList: true, subtree: true });
  });
</script>

</body>
</html>
